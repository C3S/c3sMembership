<html xmlns="http://www.w3.org/1999/xhtml"
        xml:lang="en"
        xmlns:tal="http://xml.zope.org/namespaces/tal"
        xmlns:metal="http://xml.zope.org/namespaces/metal"
        metal:use-macro="backend"
        i18n:domain="c3smembership">
    <tal:block metal:fill-slot="content">
        <h1>Details for Member Application #${member.id}</h1>
        <a href="${request.route_url('edit', _id=member.id)}" class="btn btn-warning">edit</a>
        <a href="${request.route_url('delete_entry', memberid=member.id)}"
                class="btn btn-danger"
                tal:condition="not member.membership_accepted">
            delete
        </a>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active"
                        id="entity-tab"
                        data-toggle="tab"
                        href="#entity"
                        role="tab"
                        aria-controls="entity"
                        aria-selected="true">
                    Entity
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                        id="application-tab"
                        data-toggle="tab"
                        href="#application"
                        role="tab"
                        aria-controls="application"
                        aria-selected="false">
                    Application
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link"
                        id="membership-tab"
                        data-toggle="tab"
                        href="#membership"
                        role="tab"
                        aria-controls="membership"
                        aria-selected="false">
                    Membership
                </a>
            </li>
            <li class="nav-item"
                    tal:condition="member.membership_date is not None
                        and member.membership_accepted">
                <a class="nav-link"
                        id="general-assembly-tab"
                        data-toggle="tab"
                        href="#general-assembly"
                        role="tab"
                        aria-controls="general-assembly"
                        aria-selected="false">
                    General Assembly
                </a>
            </li>
            <li class="nav-item" tal:condition="member.membership_accepted">
                <a class="nav-link"
                        id="dues-tab"
                        data-toggle="tab"
                        href="#dues"
                        role="tab"
                        aria-controls="dues"
                        aria-selected="false">
                    Dues
                </a>
            </li>
            <li class="nav-item" tal:condition="member.membership_accepted">
                <a class="nav-link"
                        id="balance-tab"
                        data-toggle="tab"
                        href="#balance"
                        role="tab"
                        aria-controls="balance"
                        aria-selected="false">
                    Balance
                </a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active"
                    id="entity"
                    role="tabpanel"
                    aria-labelledby="entity-tab">
                <h2>Entity</h2>
                <table class="table table-striped">
                    <tr>
                        <td>Firstname</td>
                        <td>${member.firstname}</td>
                    </tr>
                    <tr>
                        <td>Lastname</td>
                        <td>${member.lastname}</td>
                    </tr>
                    <tr>
                        <td>Email address</td>
                        <td><a href="mailto:${member.email}">${member.email}</a></td>
                    </tr>
                    <tr>
                        <td>Email address confirmed</td>
                        <td>${python: u'Yes' if member.email_is_confirmed else u'No.'}</td>
                    </tr>
                    <tr>
                        <td>Address line 1</td>
                        <td>${member.address1}</td>
                    </tr>
                    <tr>
                        <td>Address line 2</td>
                        <td>${member.address2}</td>
                    </tr>
                    <tr>
                        <td>Postcode</td>
                        <td>${member.postcode}</td>
                    </tr>
                    <tr>
                        <td>City</td>
                        <td>${member.city}</td>
                    </tr>
                    <tr>
                        <td>Country</td>
                        <td>${member.country}</td>
                    </tr>
                    <tr>
                        <td>Locale</td>
                        <td>${member.locale}</td>
                    </tr>
                    <tr>
                        <td>Date of birth</td>
                        <td>${member.date_of_birth}</td>
                    </tr>
                    <tr>
                        <td>Entity type</td>
                        <td>${u'Legal entity' if member.is_legalentity else 'Natural person'}</td>
                    </tr>
                    <tr>
                        <td>Code</td>
                        <td>${member.email_confirm_code}</td>
                    </tr>
                    <tr>
                        <td>Duplicate</td>
                        <td>${'Yes' if member.is_duplicate else 'No/Unknown'}</td>
                    </tr>
                    <tr tal:condition="member.is_duplicate">
                        <td>Duplicate of</td>
                        <td>
                            <a href="${request.route_url('detail', memberid=member.is_duplicate_of)}">
                                ${member.is_duplicate_of}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td>Privacy consent</td>
                        <td>${member.privacy_consent.strftime('%Y-%m-%d %H:%M:%S') if member.privacy_consent is not None else ''}</td>
                    </tr>
                    <tr>
                        <td><a name="comment"></a>Staff comment</td>
                        <td>${member.accountant_comment}</td>
                    </tr>
                </table>
            </div>
            <div class="tab-pane fade"
                    id="application"
                    role="tabpanel"
                    aria-labelledby="application-tab">
                <h2>Membership</h2>
                <table class="table table-striped">
                    <tr tal:condition="member.signature_received and member.payment_received and not member.membership_accepted">
                        <td>Ready for membership!</td>
                        <td>
                            <div tal:condition="member.signature_received and member.payment_received">
                                <a href="${request.route_url('make_member', afm_id=member.id)}"
                                        class="btn btn-success">
                                    Make member
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>Date of submission</td>
                        <td>${member.date_of_submission.strftime('%Y-%m-%d')}</td>
                    </tr>
                    <tr>
                        <td>Signature received</td>
                        <td>
                            <div tal:condition="not member.signature_received">
                                <div class="btn btn-danger" title="immer noch nicht">
                                    No
                                </div>
                                <a href="${request.route_url('regenerate_pdf', code=member.email_confirm_code)}"
                                        download="${request.route_url('regenerate_pdf', code=member.email_confirm_code)}"
                                        class="btn btn-success">
                                    Generate PDF
                                </a>
                                <a href="${request.route_url('switch_sig', memberid=member.id)}"
                                        class="btn btn-primary">
                                    Confirm signature
                                </a>
                                <?python
                                    signature_number_text = \
                                        'Send signature reminder no. {0}' \
                                        .format(int(member.sent_signature_reminder + 1))
                                    last_signature_text = ''
                                    if member.sent_signature_reminder > 0:
                                        last_signature_text = \
                                            ', last sent on {0}' \
                                            .format(member.sent_signature_reminder_date.strftime('%Y-%m-%d'))
                                    signature_reminder_title = signature_number_text + last_signature_text
                                ?>
                                <a href="${request.route_url('mail_sig_reminder', memberid=member.id)}"
                                        title="${signature_reminder_title}"
                                        class="btn btn-warning">
                                    Send reminder
                                </a>
                            </div>
                            <div tal:condition="member.signature_received">
                                <a href="${request.route_url('switch_sig', memberid=member.id)}"
                                        class="btn btn-success"
                                        title="${member.signature_received_date} (click to revoke)">
                                    Yes
                                </a>
                                <a href="${request.route_url('mail_sig_confirmation', memberid=member.id)}"
                                        class="btn btn-success"
                                        tal:condition="not member.signature_confirmed">
                                    Send confirmation email
                                </a>
                                <a href="${request.route_url('mail_sig_confirmation', memberid=member.id)}"
                                        class="btn btn-success"
                                        tal:condition="member.signature_confirmed">
                                    Resent confirmation email
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr tal:condition="member.signature_received">
                        <td>Signature reception date</td>
                        <td>${member.signature_received_date}</td>
                    </tr>
                    <tr>
                        <td>Signature confirmed</td>
                        <td>${member.signature_confirmed or "No"}</td>
                    </tr>
                    <tr tal:condition="member.signature_confirmed">
                        <td>Signature confirmation date</td>
                        <td>${member.signature_confirmed_date}</td>
                    </tr>
                    <tr>
                        <td>Payment received</td>
                        <td>
                            <div tal:condition="not member.payment_received">
                                <div class="btn btn-danger">No</div>
                                <a href="${request.route_url('switch_pay', memberid=member.id)}"
                                        class="btn btn-primary">
                                    Confirm payment
                                </a>
                                <?python
                                    payment_number_text = \
                                        'Send payment reminder no. {0}' \
                                        .format(int(member.sent_payment_reminder + 1))
                                    last_payment_text = ''
                                    if member.sent_payment_reminder > 0:
                                        last_payment_text = \
                                            ', last sent on {0}' \
                                            .format(member.sent_payment_reminder_date.strftime('%Y-%m-%d'))
                                    payment_reminder_title = payment_number_text + last_payment_text
                                ?>
                                <a href="${request.route_url('mail_pay_reminder', memberid=member.id)}"
                                        title="${payment_reminder_title}"
                                        class="btn btn-warning">
                                    Send reminder
                                </a>
                            </div>
                            <div tal:condition="member.payment_received">
                                <a href="${request.route_url('switch_pay', memberid=member.id)}"
                                        class="btn btn-success"
                                        title="${member.payment_received_date} (click to revoke)">
                                    Yes
                                </a>
                                <a href="${request.route_url('mail_pay_confirmation', member_id=member.id)}"
                                        class="btn btn-success"
                                        tal:condition="not member.payment_confirmed">
                                    Send confirmation email
                                </a>
                                <a href="${request.route_url('mail_pay_confirmation', member_id=member.id)}"
                                        class="btn btn-success"
                                    tal:condition="member.payment_confirmed">
                                    Resend confirmation email
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr tal:condition="member.payment_received">
                        <td>Payment reception date</td>
                        <td>${member.payment_received_date}</td>
                    </tr>
                    <tr>
                        <td>Payment confirmed</td>
                        <td>${member.payment_confirmed or "No"}</td>
                    </tr>
                    <tr tal:condition="member.payment_confirmed">
                        <td>Payment confirmation date</td>
                        <td>${member.payment_confirmed_date}</td>
                    </tr>
                </table>
            </div>
            <div class="tab-pane fade"
                    id="membership"
                    role="tabpanel"
                    aria-labelledby="membership-tab">
                <h2>Membership</h2>
                <table class="table table-striped">
                    <tr>
                        <td>Membership type</td>
                        <td>${member.membership_type}</td>
                    </tr>
                    <tr>
                        <td>Membership accepted</td>
                        <td>
                            ${'Yes' if member.membership_accepted else 'No'}
                        </td>
                    </tr>
                    <tr tal:condition="member.membership_accepted">
                        <td>Membership number</td>
                        <td>
                            ${member.membership_number}
                        </td>
                    </tr>
                    <tr tal:condition="member.membership_accepted">
                        <td>Membership date</td>
                        <td>${member.membership_date.strftime('%Y-%m-%d') if member.membership_date is not None else ''}</td>
                    </tr>
                    <tr>
                        <td>Membership loss date</td>
                        <td>${member.membership_loss_date.strftime('%Y-%m-%d') if member.membership_loss_date is not None else ''}</td>
                    </tr>
                    <tr>
                        <td>Membership loss type</td>
                        <td>${member.membership_loss_type}</td>
                    </tr>
                    <tr>
                        <td>Member of collecting societies</td>
                        <td>${'Yes' if member.member_of_colsoc else 'No'} ${member.name_of_colsoc if member.member_of_colsoc else ''}</td>
                    </tr>
                    <tr>
                        <td>Shares</td>
                        <td>
                            Total: ${member.num_shares}<br />
                            ${len(shares)} package(s):
                            <div>
                                <table>
                                    <tr tal:repeat="s shares">
                                        <td>${s.number} shares</td>
                                        <td style="white-space:nowrap;">
                                            <a href="${request.route_url('shares_detail', id=s.id)}">
                                                (<small>${s.date_of_acquisition.strftime('%Y-%m-%d')}</small>)
                                            </a>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </td>
                    </tr>
                    <tr tal:condition="member.is_member()">
                        <td>
                            Send membership certificate email
                            <small>
                                Ein Klick hier setzt ein (neues) Token und versendet eine Email mit Link.<br />
                                Der Link enthält auch das Token, ohne welches KEIN pdf generiert wird.<br />
                                Ausserdem wird überprüft, ob das Token älter ist als 14 Tage; in dem fall gibt es KEIN PDF.
                            </small>
                        </td>
                        <td>
                            <a tal:condition="not member.certificate_email"
                                    href="${request.route_url('certificate_mail', id=member.id)}"
                                    title="certificate not sent yet"
                                    class="btn btn-warning">
                                Never
                            </a>
                            <a tal:condition="member.certificate_email"
                                    href="${request.route_url('certificate_mail', id=member.id)}"
                                    title="gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}"
                                    class="btn btn-success">
                                Sent ${member.certificate_email_date.strftime('on %Y-%m-%d at %H:%M')}
                            </a>
                            <small>
                                Ein Klick hier setzt ein (neues) Token und versendet eine E-Mail mit Link.<br />
                                Der Link enthält auch das Token, ohne welches KEIN pdf generiert wird.<br />
                                Ausserdem wird überprüft, ob das Token älter ist als 14 Tage; in dem fall gibt es KEIN PDF.
                            </small>
                        </td>
                    </tr>
                    <tr tal:condition="member.is_member()">
                        <td>PDF download</td>
                        <td>
                            <a href="${request.route_url('certificate_pdf_staff', id=member.id, name=member.get_url_safe_name())}"
                                    title="View membership certificate"
                                    class="btn btn-success">
                                Generate and download PDF
                            </a>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="tab-pane fade"
                    id="general-assembly"
                    role="tabpanel"
                    aria-labelledby="general-assembly-tab"
                    tal:condition="member.membership_date is not None
                        and member.membership_accepted">
                <div metal:use-macro="load: c3smembership.presentation:templates/page-elements/membership_member_detail_general_assembly.pt"></div>
            </div>
            <div class="tab-pane fade"
                    id="dues"
                    role="tabpanel"
                    aria-labelledby="dues-tab"
                    tal:condition="member.membership_accepted">
                <div tal:condition="member.membership_accepted">
                    <div tal:omit-tag="" tal:condition="not member.membership_date > date(2015,12,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2015,1,1))">
                        <a name="dues15"></a>
                        <h2 id="certificate">Membership Dues 2015</h2>
                        <table class="table table-striped">
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues15_invoice
                                    and not member.dues15_paid
                                    and not member.dues15_balanced">
                                <td>
                                    Zahlungseingang<br/>
                                    <small>
                                        Hier kann der Zahlungseingang mit Datum vermerkt werden.
                                    </small>
                                </td>
                                <td>
                                    <p>
                                        <form class="form-inline"
                                                action="${request.route_url('dues15_notice', member_id=member.id)}"
                                                method="post">
                                            <label>Betrag eingegangen:</label>
                                            <input type="text"
                                                    class="form-control"
                                                    title="foo"
                                                    name="amount"
                                                    value="" />
                                            <br />
                                            Eingangsdatum (yyyy-mm-dd):
                                            <input name="payment_date"
                                                    class="form-control"
                                                    type="text"
                                                    value="${date.today().strftime('%Y-%m-%d')}" />
                                            <br />
                                            <input name="submit" type="submit"
                                                    class="btn btn-primary"
                                                    value="Zahlungseingang bestätigen." />
                                        </form>
                                    </p>
                                    <p tal:define="messages request.session.pop_flash('dues15notice_message_to_staff')"
                                            tal:condition="messages"
                                            tal:attributes="class 'alert alert-danger'">
                                        <span color="red" tal:repeat="message messages">
                                            ${message}
                                        </span>
                                        <br />
                                    </p>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues15_invoice
                                    and member.dues15_paid
                                    or member.dues15_balanced">
                                <td>Zahlungseingang<br/>
                                    <small>
                                        Hier ist der Zahlungseingang mit Datum vermerkt.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped">
                                        <tr>
                                            <td>Betrag eingegangen:</td>
                                            <td>${member.dues15_amount_paid}</td>
                                        </tr>
                                        <tr>
                                            <td>Eingangsdatum:</td>
                                            <td>${member.dues15_paid_date}</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type and member.dues15_invoice">
                                <td>
                                    Rechnungen
                                    <br/>
                                    <small>
                                        Hier siehst Du die erstellten Rechnungen für dieses Mitglied.<br/>
                                        Falls vorhanden in der vorletzten Zeile (über SALDO) auch einen Zahlungseingang.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped" rules="rows">
                                        <tr class="table-striped">
                                            <th>invoice no</th>
                                            <th>invoice string<br/>(download PDF)</th>
                                            <th>date</th>
                                            <th>amount</th>
                                            <th>was<br/>reversed?</th>
                                            <th>is<br/>reversal?</th>
                                            <th>default or<br/>altered?</th>
                                        </tr>
                                        <!--! loop over the list of invoices -->
                                        <tr tal:define="global i_saldo python:0"
                                                tal:repeat="i invoices15"
                                                tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                                            <td>
                                                <a title="${i.invoice_no}">${i.invoice_no}</a>
                                            </td>
                                            <td>
                                                <!--! if this invoice is a normal invoice -->
                                                <a tal:condition="not i.is_reversal"
                                                        href="${request.route_url('make_dues15_invoice_no_pdf',
                                                            i=str(i.invoice_no).zfill(4),
                                                            email=i.email,
                                                            code=i.token)}"
                                                        title="download ${i.invoice_no_string}.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                                <!--! if this invoice is a REVERSAL INVOICE -->
                                                <a  tal:condition="i.is_reversal"
                                                        href="${request.route_url('make_dues15_reversal_invoice_pdf',
                                                            no=str(i.invoice_no).zfill(4),
                                                            email=i.email,
                                                            code=i.token)}"
                                                        title="download ${i.invoice_no_string}-S.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                            </td>
                                            <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                                                ${i.invoice_amount}
                                            </td>
                                            <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                                            <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                                            <td>${'altered' if i.is_altered else ''}</td>
                                        </tr>
                                        <tr tal:condition="member.dues15_paid">
                                            <td>n/a</td>
                                            <td>Zahlungseingang</td>
                                            <td>${member.dues15_paid_date.strftime('%Y-%m-%d')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues15_amount_paid)">
                                                ${member.dues15_amount_paid}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            </tr>
                                            <tr>
                                            <td></td>
                                            <td>saldo:</td>
                                            <td></td>
                                            <td>${i_saldo}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div tal:omit-tag="" tal:condition="not member.membership_date > date(2016,12,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2016,1,1))">
                        <a name="dues16"></a>
                        <h2 id="certificate">Membership Dues 2016</h2>
                        <table class="table table-striped">
                            <!--! payments for dues -->
                            <!--! case one: not paid yet -->
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues16_invoice
                                    and not member.dues16_paid
                                    and not member.dues16_balanced">
                                <td>
                                    Zahlungseingang
                                    <br/>
                                    <small>
                                        Hier kann der Zahlungseingang mit Datum vermerkt werden.
                                    </small>
                                </td>
                                <td>
                                    <p>
                                        <form class="form-inline"
                                                action="${request.route_url('dues16_notice', member_id=member.id)}"
                                                method="post">
                                            <label>Betrag eingegangen:</label>
                                            <input type="text"
                                                    class="form-control"
                                                    title="foo"
                                                    name="amount"
                                                    value="" />
                                            <br />
                                            Eingangsdatum (yyyy-mm-dd):
                                            <input name="payment_date"
                                                    class="form-control"
                                                    type="text"
                                                    value="${date.today().strftime('%Y-%m-%d')}" />
                                            <br />
                                            <input name="submit" type="submit"
                                                    class="btn btn-primary"
                                                    value="Zahlungseingang bestätigen." />
                                        </form>
                                    </p>
                                    <p tal:define="messages request.session.pop_flash('dues16notice_message_to_staff')"
                                            tal:condition="messages"
                                            tal:attributes="class 'alert alert-danger'">
                                        <span color="red" tal:repeat="message messages">
                                            ${message}
                                        </span>
                                        <br />
                                    </p>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues16_invoice
                                    and member.dues16_paid
                                    or member.dues16_balanced">
                                <td>
                                    Zahlungseingang
                                    <br/>
                                    <small>
                                        Hier ist der Zahlungseingang mit Datum vermerkt.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped">
                                        <tr>
                                            <td>Betrag eingegangen:</td>
                                            <td>${member.dues16_amount_paid}</td>
                                        </tr>
                                        <tr>
                                            <td>Eingangsdatum:</td>
                                            <td>${member.dues16_paid_date}</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type and member.dues16_invoice">
                                <td>
                                    Rechnungen
                                    <br/>
                                    <small>
                                        Hier siehst Du die erstellten Rechnungen für dieses Mitglied.<br/>
                                        Falls vorhanden in der vorletzten Zeile (über SALDO) auch einen Zahlungseingang.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped" rules="rows">
                                        <tr class="table-striped">
                                            <th>invoice no</th>
                                            <th>invoice string<br/>(download PDF)</th>
                                            <th>date</th>
                                            <th>amount</th>
                                            <th>was<br/>reversed?</th>
                                            <th>is<br/>reversal?</th>
                                            <th>default or<br/>altered?</th>
                                        </tr>

                                        <!--! loop over the list of invoices -->
                                        <tr tal:define="global i_saldo python:0"
                                                tal:repeat="i invoices16"
                                                tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                                            <td>
                                                <a title="${i.invoice_no}">
                                                    ${i.invoice_no}
                                                </a>
                                            </td>
                                            <td>
                                                <!--! if this invoice is a normal invoice -->
                                                <a tal:condition="not i.is_reversal"
                                                        href="${request.route_url('make_dues16_invoice_no_pdf',
                                                            i=str(i.invoice_no).zfill(4),
                                                            email=i.email,
                                                            code=i.token)}"
                                                        title="download ${i.invoice_no_string}.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                                <!--! if this invoice is a REVERSAL INVOICE -->
                                                <a  tal:condition="i.is_reversal"
                                                        href="${request.route_url('make_dues16_reversal_invoice_pdf',
                                                            no=str(i.invoice_no).zfill(4),
                                                            email=i.email,
                                                            code=i.token)}"
                                                        title="download ${i.invoice_no_string}-S.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                            </td>
                                            <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                                                ${i.invoice_amount}</td>
                                            <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                                            <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                                            <td>${'altered' if i.is_altered else ''}</td>
                                        </tr>
                                        <tr tal:condition="member.dues16_paid">
                                            <td>n/a</td>
                                            <td>Zahlungseingang</td>
                                            <td>${member.dues16_paid_date.strftime('%Y-%m-%d')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues16_amount_paid)">
                                            ${member.dues16_amount_paid}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td>SALDO: </td>
                                            <td></td>
                                            <td>${i_saldo}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>


                    <div tal:omit-tag="" tal:condition="not member.membership_date > date(2017,12,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2017,1,1))">
                        <a name="dues17"></a>
                        <h2 id="certificate">Membership Dues 2017</h2>
                        <table class="table table-striped">
                            <tr>
                                <td>
                                    Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
                                    <small>
                                        Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                                        setzt ein (neues) Token und versendet eine Email,<br/>
                                        bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                                        Der versandte Link enthält das Token, ohne welches KEIN pdf generiert wird.
                                    </small>
                                </td>
                                <td>
                                    <a tal:condition="not member.dues17_invoice"
                                            href="${request.route_url('send_dues17_invoice_email', member_id=member.id)}"
                                            title="dues invoice not sent yet"
                                            class="btn btn-warning">
                                        Noch nicht berechnet und verschickt.
                                        <br/>
                                        Jetzt berechnen &amp; versenden: Klick!
                                    </a>
                                    <a tal:condition="member.dues17_invoice"
                                            href="${request.route_url('send_dues17_invoice_email', member_id=member.id)}"
                                            title="gesendet ${member.dues17_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                                            class="btn btn-success">
                                        gesendet ${member.dues17_invoice_date.strftime('am %d.%m.%Y um %H:%M')}.
                                        Klicken zum wiederholten versenden.
                                    </a>
                                </td>
                            </tr>
                            <!--! reduction / exemption -->
                            <tr tal:condition="'investing' not in member.membership_type and member.dues17_invoice">
                                <td>
                                    Ermäßigung/Erlass
                                    <br/>
                                    <small>
                                        Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                                        Du kannst im Falle eines Antrags auf Ermäßigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                                        Daraufhin wird die alte Rechnung storniert.
                                        Das Mitglied erhält eine E-Mail.<br/>
                                        Diese enthält Links auf die Storno-Rechnung
                                        und eine neue geänderte Rechnung.
                                    </small>
                                </td>
                                <td>
                                    <table>
                                        <tr>
                                            <td><small>müsste zahlen:</small></td>
                                            <td>${member.dues17_start}</td>
                                        </tr>
                                        <tr>
                                            <td><small>berechn. Beitrag: &nbsp;</small></td>
                                            <td>${member.dues17_amount} Euro</td>
                                        </tr>
                                        <tr>
                                            <td><small>ermäßigter Beitrag: &nbsp;</small></td>
                                            <td tal:condition="not member.dues17_reduced">
                                                kein Antrag gestellt
                                            </td>
                                            <td tal:condition="member.dues17_reduced">
                                                ${member.dues17_amount_reduced} Euro
                                            </td>
                                        </tr>
                                    </table>
                                    <p>

                                        <form tal:condition="not member.dues17_balanced"
                                                id="dues17_form"
                                                class="form-inline"
                                                action="${request.route_url('dues17_reduction', member_id=member.id)}"
                                                method="post">
                                            <label>ermäßigen auf:</label>
                                            <input type="hidden"
                                                    name="confirmed"
                                                    value="no" />
                                            <input type="text"
                                                    class="form-control"
                                                    title="foo"
                                                    name="amount"
                                                    value="" />
                                            <input id="dues17_reduce_submit"
                                                    type="submit"
                                                    name="submit"
                                                    class="btn btn-primary"
                                                    value="Reduce Dues" />
                                        </form>
                                    </p>
                                    <p tal:define="messages request.session.pop_flash('dues17_message_to_staff')"
                                            tal:condition="messages"
                                            tal:attributes="class 'alert alert-danger'">
                                        <span color="red" tal:repeat="message messages">
                                            ${message}
                                        </span>
                                        <br />
                                    </p>
                                    <p>
                                        see also
                                        <a href="${request.route_url('dues17_listing')}"
                                                class="btn btn-primary">
                                            Dues17 Invoices Listing
                                        </a>
                                    </p>
                                </td>
                            </tr>
                            <!--! payments for dues -->
                            <!--! case one: not paid yet -->
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues17_invoice
                                    and not member.dues17_paid
                                    and not member.dues17_balanced">
                                <td>
                                    Zahlungseingang
                                    <br/>
                                    <small>
                                        Hier kann der Zahlungseingang mit Datum vermerkt werden.
                                    </small>
                                </td>
                                <td>
                                    <p>
                                        <form class="form-inline"
                                                action="${request.route_url('dues17_notice', member_id=member.id)}"
                                                method="post">
                                            <label>Betrag eingegangen:</label>
                                            <input type="text"
                                                    class="form-control"
                                                    title="foo"
                                                    name="amount"
                                                    value="" />
                                            <br />
                                            Eingangsdatum (yyyy-mm-dd):
                                            <input name="payment_date"
                                                    class="form-control"
                                                    type="text"
                                                    value="${date.today().strftime('%Y-%m-%d')}" />
                                            <br />
                                            <input name="submit" type="submit"
                                                    class="btn btn-primary"
                                                    value="Zahlungseingang bestätigen." />
                                        </form>
                                    </p>
                                    <p tal:define="messages request.session.pop_flash('dues17notice_message_to_staff')"
                                            tal:condition="messages"
                                            tal:attributes="class 'alert alert-danger'">
                                        <span color="red" tal:repeat="message messages">
                                            ${message}
                                        </span>
                                        <br />
                                    </p>
                                </td>
                            </tr>
                            <!-- case two: already paid OR dues exempted-->
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues17_invoice
                                    and member.dues17_paid
                                    or member.dues17_balanced">
                                <td>
                                    Zahlungseingang
                                    <br/>
                                    <small>
                                        Hier ist der Zahlungseingang mit Datum vermerkt.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped">
                                        <tr>
                                            <td>Betrag eingegangen:</td>
                                            <td>${member.dues17_amount_paid}</td>
                                        </tr>
                                        <tr>
                                            <td>Eingangsdatum:</td>
                                            <td>${member.dues17_paid_date}</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type and member.dues17_invoice">
                                <td>Rechnungen<br/>
                                    <small>
                                        Hier siehst Du die erstellten Rechnungen für dieses Mitglied.<br/>
                                        Falls vorhanden in der vorletzten Zeile (über SALDO) auch einen Zahlungseingang.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped" rules="rows">
                                        <tr class="table-striped">
                                            <th>invoice no</th>
                                            <th>invoice string<br/>(download PDF)</th>
                                            <th>date</th>
                                            <th>amount</th>
                                            <th>was<br/>reversed?</th>
                                            <th>is<br/>reversal?</th>
                                            <th>default or<br/>altered?</th>
                                        </tr>

                                        <!--! loop over the list of invoices -->
                                        <tr tal:define="global i_saldo python:0"
                                                tal:repeat="i invoices17"
                                                tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                                            <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                                            <td>
                                                <!--! if this invoice is a normal invoice -->
                                                <a tal:condition="not i.is_reversal"
                                                        href="${request.route_url('make_dues17_invoice_no_pdf',
                                                            i=str(i.invoice_no).zfill(4),
                                                            email=i.email,
                                                            code=i.token)}"
                                                        title="download ${i.invoice_no_string}.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                                <!--! if this invoice is a REVERSAL INVOICE -->
                                                <a tal:condition="i.is_reversal"
                                                        href="${request.route_url('make_dues17_reversal_invoice_pdf',
                                                            no=str(i.invoice_no).zfill(4),
                                                            email=i.email,
                                                            code=i.token)}"
                                                        title="download ${i.invoice_no_string}-S.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                            </td>
                                            <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                                                ${i.invoice_amount}
                                            </td>
                                            <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                                            <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                                            <td>${'altered' if i.is_altered else ''}</td>
                                        </tr>
                                        <tr tal:condition="member.dues17_paid">
                                            <td>n/a</td>
                                            <td>Zahlungseingang</td>
                                            <td>${member.dues17_paid_date.strftime('%Y-%m-%d')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues17_amount_paid)">
                                                ${member.dues17_amount_paid}
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td>SALDO: </td>
                                            <td></td>
                                            <td>${i_saldo}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018,12,31) and (member.membership_loss_date is None or member.membership_loss_date >= date(2018,1,1))">
                        <a name="dues18"></a>
                        <h2 id="certificate">Membership Dues 2018</h2>
                        <table class="table table-striped">
                            <tr>
                                <td>
                                    Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
                                    <small>
                                        Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                                        setzt ein (neues) Token und versendet eine Email,<br/>
                                        bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                                        Der versandte Link enthält das Token, ohne welches KEIN pdf generiert wird.
                                    </small>
                                </td>
                                <td>
                                    <a tal:condition="not member.dues18_invoice"
                                            href="${request.route_url('send_dues18_invoice_email', member_id=member.id)}"
                                            title="dues invoice not sent yet"
                                            class="btn btn-warning">
                                        Noch nicht berechnet und verschickt. <br/>
                                        Jetzt berechnen &amp; versenden: Klick!
                                    </a>
                                    <a tal:condition="member.dues18_invoice"
                                            href="${request.route_url('send_dues18_invoice_email', member_id=member.id)}"
                                            title="gesendet ${member.dues18_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                                            class="btn btn-success">
                                        gesendet ${member.dues18_invoice_date.strftime('am %d.%m.%Y um %H:%M')}.
                                        Klicken zum wiederholten versenden.
                                    </a>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type and member.dues18_invoice">
                                <td>PDF generieren (download)</td>
                                <td>
                                    <a href="${request.route_url('dues18_invoice_pdf_backend',
                                                i=str(member.dues18_invoice_no).zfill(4))}"
                                            title="Mitgliedschaftsbeitragsrechnung ansehen"
                                            class="btn btn-success">
                                        PDF generieren und laden
                                    </a>
                                </td>
                            </tr>
                            <!--! reduction / exemption -->
                            <tr tal:condition="'investing' not in member.membership_type and member.dues18_invoice">
                                <td>
                                    Ermäßigung/Erlass
                                    <br/>
                                    <small>
                                        Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                                        Du kannst im Falle eines Antrags auf Ermäßigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                                        Daraufhin wird die alte Rechnung storniert.
                                        Das Mitglied erhält eine E-Mail.<br/>
                                        Diese enthält Links auf die Storno-Rechnung
                                        und eine neue geänderte Rechnung.
                                    </small>
                                </td>
                                <td>
                                    <table>
                                        <tr>
                                            <td><small>müsste zahlen:</small></td>
                                            <td>${member.dues18_start}</td>
                                        </tr>
                                        <tr>
                                            <td><small>berechn. Beitrag: &nbsp;</small></td>
                                            <td>${member.dues18_amount} Euro</td>
                                        </tr>
                                        <tr>
                                            <td><small>ermäßigter Beitrag: &nbsp;</small></td>
                                            <td tal:condition="not member.dues18_reduced">
                                                kein Antrag gestellt
                                            </td>
                                            <td tal:condition="member.dues18_reduced">
                                                ${member.dues18_amount_reduced} Euro
                                            </td>
                                        </tr>
                                    </table>
                                    <p>
                                        <form tal:condition="not member.dues18_balanced"
                                                id="dues18_form"
                                                class="form-inline"
                                                action="${request.route_url('dues18_reduction', member_id=member.id)}"
                                                method="post">
                                            <label>ermäßigen auf:</label>
                                            <input type="hidden"
                                                    name="confirmed"
                                                    value="no" />
                                            <input type="text"
                                                    class="form-control"
                                                    title="foo"
                                                    name="amount"
                                                    value="" />
                                            <input id="dues18_reduce_submit"
                                                    type="submit"
                                                    name="submit"
                                                    class="btn btn-primary"
                                                    value="Reduce Dues" />
                                        </form>
                                    </p>
                                    <p tal:define="messages request.session.pop_flash('dues18_message_to_staff')"
                                            tal:condition="messages"
                                            tal:attributes="class 'alert alert-danger'">
                                        <span color="red"
                                                tal:repeat="message messages">
                                            ${message}
                                        </span>
                                        <br />
                                    </p>
                                    <p>
                                        see also
                                        <a href="${request.route_url('dues18_listing')}"
                                                class="btn btn-primary">
                                            Dues18 Invoices Listing
                                        </a>
                                    </p>
                                </td>
                            </tr>
                            <!--! payments for dues -->
                            <!--! case one: not paid yet -->
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues18_invoice
                                    and not member.dues18_paid
                                    and not member.dues18_balanced">
                                <td>Zahlungseingang<br/>
                                    <small>
                                        Hier kann der Zahlungseingang mit Datum vermerkt werden.
                                    </small>
                                </td>
                                <td>
                                    <p>
                                        <form class="form-inline"
                                                action="${request.route_url('dues18_notice', member_id=member.id)}"
                                                method="post">
                                            <label>Betrag eingegangen:</label>
                                            <input type="text"
                                                    class="form-control"
                                                    title="foo"
                                                    name="amount"
                                                    value="" />
                                            <br />
                                            Eingangsdatum (yyyy-mm-dd):
                                            <input name="payment_date"
                                                    class="form-control"
                                                    type="text"
                                                    value="${date.today().strftime('%Y-%m-%d')}" />
                                            <br />
                                            <input name="submit" type="submit"
                                                    class="btn btn-primary"
                                                    value="Zahlungseingang bestätigen." />
                                        </form>
                                    </p>
                                    <p tal:define="messages request.session.pop_flash('dues18notice_message_to_staff')"
                                            tal:condition="messages"
                                            tal:attributes="class 'alert alert-danger'">
                                        <span color="red" tal:repeat="message messages">
                                            ${message}
                                        </span>
                                        <br />
                                    </p>
                                </td>
                            </tr>
                            <!-- case two: already paid OR dues exempted-->
                            <tr tal:condition="'investing' not in member.membership_type
                                    and member.dues18_invoice
                                    and member.dues18_paid
                                    or member.dues18_balanced">
                                <td>
                                    Zahlungseingang
                                    <br/>
                                    <small>
                                        Hier ist der Zahlungseingang mit Datum vermerkt.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped">
                                        <tr>
                                            <td>Betrag eingegangen:</td>
                                            <td>${member.dues18_amount_paid}</td>
                                        </tr>
                                        <tr>
                                            <td>Eingangsdatum:</td>
                                            <td>${member.dues18_paid_date}</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                            <tr tal:condition="'investing' not in member.membership_type and member.dues18_invoice">
                                <td>
                                    Rechnungen
                                    <br/>
                                    <small>
                                        Hier siehst Du die erstellten Rechnungen für dieses Mitglied.<br/>
                                        Falls vorhanden in der vorletzten Zeile (über SALDO) auch einen Zahlungseingang.
                                    </small>
                                </td>
                                <td>
                                    <table class="table table-striped" rules="rows">
                                        <tr class="table-striped">
                                            <th>invoice no</th>
                                            <th>invoice string<br/>(download PDF)</th>
                                            <th>date</th>
                                            <th>amount</th>
                                            <th>was<br/>reversed?</th>
                                            <th>is<br/>reversal?</th>
                                            <th>default or<br/>altered?</th>
                                        </tr>

                                        <!--! loop over the list of invoices -->
                                        <tr tal:define="global i_saldo python:0"
                                                tal:repeat="i invoices18"
                                                tal:attributes="id python: 'invoice_{0}'.format(i.id)">
                                            <td><a title="${i.invoice_no}">${i.invoice_no}</a></td>
                                            <td>
                                                <!--! if this invoice is a normal invoice -->
                                                <a tal:condition="not i.is_reversal"
                                                        href="${request.route_url('dues18_invoice_pdf_backend',
                                                            i=str(i.invoice_no).zfill(4))}"
                                                        title="download ${i.invoice_no_string}.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                                <!--! if this invoice is a REVERSAL INVOICE -->
                                                <a  tal:condition="i.is_reversal"
                                                        href="${request.route_url('dues18_reversal_pdf_backend',
                                                            i=str(i.invoice_no).zfill(4))}"
                                                        title="download ${i.invoice_no_string}-S.pdf">
                                                    ${i.invoice_no_string}
                                                </a>
                                            </td>
                                            <td>${i.invoice_date.strftime('%d.%m.%Y %H:%M')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) + D(i.invoice_amount)">
                                                ${i.invoice_amount}
                                            </td>
                                            <td>${'reversed by %s' % i.succeeding_invoice_no if i.is_cancelled else ''}</td>
                                            <td>${'reverses %s' % i.preceding_invoice_no if i.is_reversal else ''}</td>
                                            <td>${'altered' if i.is_altered else ''}</td>
                                        </tr>
                                        <tr tal:condition="member.dues18_paid">
                                            <td>n/a</td>
                                            <td>Zahlungseingang</td>
                                            <td>${member.dues18_paid_date.strftime('%Y-%m-%d')}</td>
                                            <td tal:define="global i_saldo python: D(i_saldo) - D(member.dues18_amount_paid)">
                                                ${member.dues18_amount_paid}
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td>SALDO: </td>
                                            <td></td>
                                            <td>${i_saldo}</td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade"
                    id="balance"
                    role="tabpanel"
                    aria-labelledby="balance-tab"
                    tal:condition="member.membership_accepted">
                <h2 id="certificate">Account Balance</h2>
                <table class="table table-striped">
                    <?python
                        balance = 0
                    ?>
                    <tr>
                        <th>Position</th>
                        <th>Amount</th>
                    </tr>
                    <tr>
                        <?python balance += member.dues15_balance ?>
                        <td>Membership dues 2015</td>
                        <td>${-member.dues15_balance}</td>
                    </tr>
                    <tr>
                        <?python balance += member.dues16_balance ?>
                        <td>Membership dues 2016</td>
                        <td>${-member.dues16_balance}</td>
                    </tr>
                    <tr>
                        <?python balance += member.dues17_balance ?>
                        <td>Membership dues 2017</td>
                        <td>${-member.dues17_balance}</td>
                    </tr>
                    <tr>
                        <?python balance += member.dues18_balance ?>
                        <td>Membership dues 2018</td>
                        <td>${-member.dues18_balance}</td>
                    </tr>
                    <tr>
                        <?python
                            balanced = (balance == 0.0)
                        ?>
                        <th>Account balance</th>
                        <th tal:condition="not balanced" class="alert alert-danger">
                            ${-balance}
                        </th>
                        <th tal:condition="balanced" class="alert alert-success">
                            ${-balance}
                        </th>
                    </tr>
                </table>
            </div>
        </div>
    </tal:block>
    <tal:block metal:fill-slot="javascript">
        <script type="text/javascript">
            $().ready(function() {
                $("#dues15_reduce_submit").click(function(event) {
                        reduction_amount = $("#dues15_form input[name='amount']").val();
                        answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                        if(answer) {
                            $("#dues15_form input[name='confirmed']").val("yes");
                        } else {
                            event.preventDefault();
                        }
                });

                $("#dues16_reduce_submit").click(function(event) {
                    reduction_amount = $("#dues16_form input[name='amount']").val();
                    answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                    if(answer) {
                        $("#dues16_form input[name='confirmed']").val("yes");
                    } else {
                        event.preventDefault();
                    }
                });

                $("#dues17_reduce_submit").click(function(event) {
                    reduction_amount = $("#dues17_form input[name='amount']").val();
                    answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                    if(answer) {
                        $("#dues17_form input[name='confirmed']").val("yes");
                    } else {
                        event.preventDefault();
                    }
                });

                $("#dues18_reduce_submit").click(function(event) {
                    reduction_amount = $("#dues18_form input[name='amount']").val();
                    answer = confirm("Are you sure you want to reduce the dues for ${member.firstname} ${member.lastname} to " + reduction_amount + "?");
                    if(answer) {
                        $("#dues18_form input[name='confirmed']").val("yes");
                    } else {
                        event.preventDefault();
                    }
                });
            });
        </script>
    </tal:block>
</html>
