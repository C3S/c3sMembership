<?python
    from babel.numbers import format_currency
    from datetime import date
?>
<html xmlns="http://www.w3.org/1999/xhtml"
        xml:lang="en"
        xmlns:tal="http://xml.zope.org/namespaces/tal"
        xmlns:metal="http://xml.zope.org/namespaces/metal"
        metal:use-macro="backend"
        i18n:domain="c3smembership">
    <tal:block metal:fill-slot="content">
        <div>
            <strong tal:repeat="message request.session.pop_flash('message_to_staff')"
                    class="text-danger">
                ${message}
            </strong>
        </div>
        <h1>Members</h1>
        <h2 tal:condition="message" class="message" id="message">
            ${message}
        </h2>
        <h3 tal:repeat="message request.session.pop_flash('messages')"
                class="message text-danger" id="message">
            ${message}
        </h3>
        <p>
            Number of data sets: ${pagination.paging.content_size}
        </p>
        <p metal:use-macro="load: c3smembership.presentation:templates/page-elements/pagination_page_links.pt"></p>
        <table class="table table-striped">
            <tr class="table-striped">
                <th>
                    <a href="${pagination.url.sort_property_alternating_direction('lastname')}"
                            title="Sort by lastname">
                        <i class="fas fa-sort"></i>
                        Lastname
                    </a>
                    <a href="${pagination.url.sort_property('lastname').sort_direction('asc')}"
                            title="Sort by lastname: ascending"
                            class="fas fa-sort-alpha-down">
                    </a>
                    <a href="${pagination.url.sort_property('lastname').sort_direction('desc')}"
                            title="Sort by lastname: descending"
                            class="fas fa-sort-alpha-down">
                    </a>
                </th>
                <th>
                    <a href="${pagination.url.sort_property_alternating_direction('firstname')}"
                            title="Sort by firstname">
                        <i class="fas fa-sort"></i>
                        Firstname
                    </a>
                    <a href="${pagination.url.sort_property('firstname').sort_direction('asc')}"
                            title="Sort by firstname: ascending"
                            class="fas fa-sort-alpha-down"></a>
                    <a href="${pagination.url.sort_property('firstname').sort_direction('desc')}"
                            title="Sort by firstname: descending"
                            class="fas fa-sort-alpha-up">
                    </a>
                </th>
                <th>Type</th>
                <th>Number</th>
                <th>Shares</th>
                <th>Email</th>
                <!--!
                <th>
                    BC &amp; GA<br />Invitation
                </th>
                -->
                <th>
                    Dues 2018<br/>Invoice
                </th>
                <th>
                    Certificate
                </th>
                <th>Edit</th>
            </tr>
            <tr tal:repeat="member members" tal:attributes="id python: 'member_{0}'.format(member.id)">
                <td>
                    <a href="${request.route_url('member_details', membership_number=member.membership_number)}">
                        ${member.lastname}
                    </a>
                </td>
                <td>
                    <a href="${request.route_url('member_details', membership_number=member.membership_number)}">
                        ${member.firstname}
                    </a>
                </td>
                <td class="icons">
                    <i tal:condition="member.membership_type == 'normal'"
                            title="Full membership getting a vote"
                            class="fas fa-hand-paper">
                    </i>
                    <i tal:condition="member.membership_type == 'investing'"
                            title="Investing membership not getting a vote"
                            class="fas fa-money-bill">
                    </i>
                </td>
                <td>${member.membership_number}</td>
                <td>
                    <a href="${request.route_url('detail', memberid=member.id)}">
                        ${member.num_shares}
                    </a>
                </td>
                <td>
                    <a href="mailto:${member.email}" title="${member.email}">mailto</a>
                </td>
                <!--!
                <td class="icons">
                    <div tal:condition="member.is_member()" tal:omit-tag="">
                        <a tal:condition="member.email_invite_flag_bcgv18 is not True"
                                href="${request.route_url('invite_member', m_id=member.id)}"
                                title="invitation not sent yet. Click to send!"
                                class="fas fa-envelope text-danger"></a>
                        <a tal:condition="member.email_invite_flag_bcgv18 is True"
                                href="${request.route_url('invite_member', m_id=member.id)}"
                                title="gesendet ${member.email_invite_date_bcgv18.strftime('am %d.%m.%Y um %H:%M')}"
                                class="fas fa-envelope text-success"></a>
                    </div>
                </td>
                -->
                <td class="icons">
                    <div tal:omit-tag="" tal:condition="not member.membership_date > date(2018, 12, 13) and (member.membership_loss_date is None or member.membership_loss_date > date(2018, 12, 31))">
                        <a tal:condition="member.dues18_invoice is False"
                                href="${request.route_url('send_dues18_invoice_email', member_id=member.id)}"
                                title="Dues invoice not sent yet. Click to send!"
                                class="fas fa-envelope text-danger"></a>
                        <a tal:condition="member.dues18_invoice is True"
                                href="${request.route_url('send_dues18_invoice_email', member_id=member.id)}"
                                title="Invoice sent at ${member.dues18_invoice_date.strftime('%d.%m.%Y %H:%M')}"
                                class="fas fa-envelope text-success"></a>
                    </div>
                </td>
                <td class="icons">
                    <a tal:condition="not member.certificate_email"
                            href="${request.route_url('certificate_mail', id=member.id)}"
                            title="certificate not sent yet"
                            class="fas fa-envelope text-danger"></a>
                    <a tal:condition="member.certificate_email"
                            href="${request.route_url('certificate_mail', id=member.id)}"
                            title="gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}"
                            class="fas fa-envelope text-success"></a>
                    <a href="${request.route_url('certificate_pdf_staff', id=member.id, name=member.get_url_safe_name())}"
                            title="Mitgliedschaftsurkunde ansehen"
                            class="fas fa-download">
                    </a>
                </td>
                <td class="icons">
                    <a href="${request.route_url('edit', _id=member.id)}"
                            class="fas fa-edit"
                            title="Edit">
                    </a>
                    <a href="${request.route_url('delete_entry', memberid=member.id, _query={'redirect': 'membership_listing_backend'})}"
                            class="fas fa-trash delete-link"
                            title="Delete"
                            id="delete-link-${member.id}">
                    </a>
                </td>
            </tr>
        </table>
        <p metal:use-macro="load: c3smembership.presentation:templates/page-elements/pagination_page_links.pt"></p>
        <p metal:use-macro="load: c3smembership.presentation:templates/page-elements/pagination_page_size_form.pt"></p>
    </tal:block>
    <tal:block metal:fill-slot="javascript">
        <script type="text/javascript">
            $().ready(function() {
                console.debug("ready");
                $(".delete-link").click(function(event) {
                    event.preventDefault();
                    member_id = $(this).attr('id').split('-')[2];
                    ajaxUrl = '${request.route_url('get_member', member_id=0)}'
                    ajaxUrl = ajaxUrl.substring(0, ajaxUrl.length - 1) + member_id;
                    member_data = $.get(
                        ajaxUrl,
                        function(member) {
                            answer = confirm("Do you want to delete member " + member.id + " \"" + member.lastname + ", " + member.firstname + "\"?");
                            if (answer) {
                                deleteUrl = '${request.route_url('delete_entry', memberid='{memberid}', _query={'redirect': 'membership_listing_backend'})}';
                                deleteUrl = deleteUrl.replace(encodeURIComponent('{memberid}'), member_id) + '&amp;deletion_confirmed=1';
                                window.location.href = deleteUrl;
                            }
                        }
                    );
                });
                $(".send-reminder").click(function(event) {
                    member_id = $(this).attr('id').split('-')[2];
                    member_name = $(this).attr('membername');
                    answer = confirm("Are you sure you want to send the reminder email to " + member_name + " (afm id " + member_id + ") ?");
                    if(answer == false) {
                        event.preventDefault();
                    }
                });
            });
        </script>
        <script src="${request.static_url('deform:static/scripts/deform.js')}"
                type="text/javascript"></script>
        </tal:block>
</html>
