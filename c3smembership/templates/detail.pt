<html xmlns="http://www.w3.org/1999/xhtml"
      xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="backend">
  <tal:block metal:fill-slot="middle">
      <p>
        Please <a href="${request.route_url('logout')}">log out</a>
        when you are done.
        Or go
        <a href="${request.route_url('dashboard_only')}"
           class="btn btn-success"
           >back to dashboard</a>
        or the 
        <a href="${request.route_url('membership_listing_backend', number=0, orderby='id', order='asc')}"
           class="btn btn-success"
           >memberships</a>.
      </p>

      <h1>Details for Member Application #${member.id}</h1>
      <a href="${request.route_url('edit', _id=member.id)}" class="btn btn-warning">edit</a>
      <a href="${request.route_url('delete_entry', memberid=member.id)}" class="btn btn-danger">delete</a>
      <table class="table table-striped">
	<tr>
          <td>code</td>
	  <td>${member.email_confirm_code}</td>
        </tr>
	<tr>
          <td>firstname</td>
	  <td>${member.firstname}</td>
        </tr>
	<tr>
          <td>lastname</td>
	  <td>${member.lastname}</td>
        </tr>
	<tr>
          <td>email</td>
	  <td><a href="mailto:${member.email}">${member.email}</a></td>
        </tr>
	<tr>
          <td>email confirmed?</td>
	  <td>${python: u'Yes' if member.email_is_confirmed else u'No.'}</td>
        </tr>
	<tr>
          <td>address1</td>
	  <td>${member.address1}</td>
        </tr>
	<tr>
          <td>address2</td>
	  <td>${member.address2}</td>
        </tr>
	<tr>
          <td>postcode</td>
	  <td>${member.postcode}</td>
        </tr>
	<tr>
          <td>city</td>
	  <td>${member.city}</td>
        </tr>
	<tr>
          <td>country</td>
	  <td>${member.country}</td>
        </tr>
	<tr>
          <td>locale</td>
	  <td>${member.locale}</td>
        </tr>
	<tr>
          <td>date_of_birth</td>
	  <td>${member.date_of_birth}</td>
        </tr>
      </table>
      
      <h3>Membership Meta</h3>
      <table class="table table-striped">
	<tr>
          <td>membership_accepted</td>
	  <td>
            ${'Yes' if member.membership_accepted else 'No'}
          </td>
        </tr>
	<tr>
	<tr tal:condition="member.membership_accepted">
          <td>membership_number</td>
	  <td>
            ${member.membership_number}
          </td>
        </tr>
	<tr tal:condition="member.membership_accepted">
          <td>membership_date</td>
	  <td>${member.membership_date}</td>
        </tr>
	<tr>
          <td>is_duplicate ?</td>
	  <td>${'Yes' if member.is_duplicate else 'No/Unknown'}</td>
        </tr>
	<tr tal:condition="member.is_duplicate">
          <td>is duplicate of</td>
	  <td>
            <a href="${request.route_url('detail', memberid=member.is_duplicate_of)}">
              ${member.is_duplicate_of}
            </a>
          </td>
        </tr>
	<tr>
          <td>
          <a name="comment"></a>staff comment</td>
	  <td>${member.accountant_comment}</td>
        </tr>

      </table>
      
      <a name="membership_info"></a>
      <h3>Membership Info</h3>

      <table class="table table-striped">
        <tr tal:condition="member.signature_received and member.payment_received and not member.membership_accepted">
          <td>ready for membership!</td>
          <td><!--! turn application into a member -->
            <div tal:condition="member.signature_received
                                and member.payment_received">
              <a href="${request.route_url('make_member',
                       afm_id=member.id)}"
                 class="btn btn-success">make member</a>
            </div>
          </td>
        </tr>
	<tr>
          <td>entity type</td>
	  <td>${u'Körperschaft' if member.is_legalentity else 'Person'}</td>
        </tr>
	<tr>
          <td>membership type</td>
	  <td>${member.membership_type}</td>
        </tr>
	<tr>
          <td>member_of_colsoc</td>
	  <td>${'Yes' if member.member_of_colsoc else 'No'}</td>
        </tr>
	<tr>
          <td>name_of_colsoc</td>
	  <td>${member.name_of_colsoc}</td>
        </tr>
	<tr>
          <td>date_of_submission</td>
	  <td>${member.date_of_submission.strftime('%Y-%m-%d')}</td>
        </tr>
	<tr>
          <td>signature received?</td>
          <td>
            <div tal:condition="not member.signature_received">
              <div class="btn btn-danger"
                   title="immer noch nicht">Nein</div>
              <!--! re-create hte Application for Membership PDF -->
              <a href="/re_C3S_SCE_AFM_${member.email_confirm_code}.pdf"
                 download="/re_C3S_SCE_AFM_${member.email_confirm_code}.pdf"
                 class="btn btn-success">
                PDF generieren
              </a>
              <a href="${request.route_url('switch_sig', memberid=member.id)}"
                 class="btn btn-primary">
                Eingang bestätigen
              </a>
              <a href="${request.route_url('mail_sig_reminder', memberid=member.id)}"
                 class="btn btn-warning">
                Erinnerung senden
              </a>
            </div>
            <div tal:condition="member.signature_received">
              <a href="${request.route_url('switch_sig', memberid=member.id)}"
                 class="btn btn-success"
                 title="${member.signature_received_date} (anklicken zum verneinen)">
                Ja</a>
            </div>
          </td>
        </tr>
	<tr tal:condition="member.signature_received">
          <td>signature reception date</td><td>${member.signature_received_date}</td>
        </tr>
	<tr>
          <td>signature confirmed (mail sent)?</td><td>${member.signature_confirmed or "No"}</td>
        </tr>
	<tr tal:condition="member.signature_confirmed">
          <td>signature confirmation date</td><td>${member.signature_confirmed_date}</td>
        </tr>
	<tr>
          <td>payment received?</td>
          <td>
            <div tal:condition="not member.payment_received">
              <div class="btn btn-danger">Nein</div>
              <a href="${request.route_url('switch_pay', memberid=member.id)}"
                 class="btn btn-primary">
                Zahlungseingang bestätigen
              </a>
              <a href="${request.route_url('mail_pay_reminder', memberid=member.id)}"
                 class="btn btn-warning">
                Erinnerung senden
              </a>
            </div>
            <div tal:condition="member.payment_received">
              <a href="${request.route_url('switch_pay', memberid=member.id)}"
                 class="btn btn-success"
                 title="${member.payment_received_date} (anklicken zum verneinen)">
                Ja</a>
            </div>
          </td>
        </tr>
	<tr tal:condition="member.payment_received">
          <td>payment reception date</td>
          <td>${member.payment_received_date}</td>
        </tr>
	<tr>
          <td>payment confirmed?</td><td>${member.payment_confirmed or "No"}</td>
        </tr>
	<tr tal:condition="member.payment_confirmed">
          <td>payment confirmation date</td><td>${member.payment_confirmed_date}</td>
        </tr>
	<tr>
          <td># shares</td>
	  <td>
            total: ${member.num_shares}<br />
            ${len(member.shares)} package(s):
          <div>
            <table>
              <tr tal:repeat="s member.shares">
                <td>${s.number} shares</td>
                <td style="white-space:nowrap;">
                  <a href="${request.route_url('shares_detail', id=s.id)}">
                    (<small>${s.date_of_acquisition.strftime('%Y-%m-%d')}</small>)
                  </a>
                </td>
              </tr>
            </table>
          </div>          

          </td>
        </tr>
      </table>

      <div tal:condition="member.membership_accepted">
        <h3 id="certificate">Membership Certificate</h3>
        <table class="table table-striped">
	  <tr>
            <td>
              Versand Mitgliedsbescheinigungs-Email<br/>
              <small>
                Ein Klick hier setzt ein (neues) Token und versendet eine Email mit Link.<br />
                Der Link enthält auch das Token, ohne welches KEIN pdf generiert wird.<br />
                Ausserdem wird überprüft, ob das Token älter ist als 14 Tage; in dem fall gibt es KEIN PDF.
              </small>

            </td>
            <td>
              <a tal:condition="not member.certificate_email"
                 href="${request.route_url('certificate_mail', id=member.id)}"
                 title="certificate not sent yet"
                 class="btn btn-warning">Noch nie.</a>
              <a tal:condition="member.certificate_email"
                 href="${request.route_url('certificate_mail', id=member.id)}"
                 title="gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}</a>
            </td>
          </tr>
          <tr>
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('certificate_pdf_staff', id=member.id, name=cert_link)}"
                 title="Mitgliedschaftsurkunde ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
        </table>
      </div>
      <!-- membership dues -->
      <div tal:condition="member.membership_accepted">
        <a name="dues15"></a>
        <h3 id="certificate">Membership Dues</h3>
        <table class="table table-striped">
	  <tr>
            <td>
              Versand Mitgliedsbeitrags-Email (Rechnung/Aufforderung)<br/>
              <small>
                Ein Klick hier berechnet den Mitgliedsbeitrag,<br/>
                setzt ein (neues) Token und versendet eine Email,<br/>
                bei normalen Mitgliedern mit Link auf die Rechnung.<br/>
                Der versandte Link enthält das Token, ohne welches KEIN pdf generiert wird.
              </small>

            </td>
            <td>
              <a tal:condition="not member.dues15_invoice"
                 href="${request.route_url('send_dues_invoice_email', member_id=member.id)}"
                 title="dues invoice not sent yet"
                 class="btn btn-warning">
                Noch nicht berechnet und verschickt. <br/>
                Jetzt berechnen &amp; versenden: Klick!</a>
              <a tal:condition="member.dues15_invoice"
                 href="${request.route_url('send_dues_invoice_email', member_id=member.id)}"
                 title="gesendet ${member.dues15_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                 class="btn btn-success">gesendet ${member.dues15_invoice_date.strftime('am %d.%m.%Y um %H:%M')}. Klicken zum wiederholten versenden.</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues15_invoice">
            <td>PDF generieren (download)</td>
            <td>
              <a href="${request.route_url('make_dues_invoice_no_pdf',
                       email=member.email,
                       code=member.dues15_token,
                       i=str(_m.dues15_invoice_no).zfill(4))}"
                 title="Mitgliedschaftsbeitragsrechnung ansehen"
                 class="btn btn-success">PDF generieren und laden</a>
            </td>
          </tr>
          <tr tal:condition="'investing' not in member.membership_type and member.dues15_invoice">
            <td>Ermäßigung/Erlass<br/>
              <small>
                Hier siehst Du den errechneten Mitgliedsbeitrag.<br/>
                Du kannst im Falle eines Antrags auf Ermäßigung einen neuen Betrag festsetzen -- auch 0 Euro.<br/>
                Daraufhin wird die alte Rechnung storniert.
                Das Mitglied erhält eine E-Mail.<br/>
                Diese enthält Links auf die Storno-Rechnung
                und eine neue geänderte Rechnung.
              </small>
            </td>
            <td>
              <table>
                <tr>
                  <td><small>müsste zahlen:</small></td>
                  <td>${member.dues15_start}</td>
                </tr>
                <tr>
                  <td><small>berechn. Beitrag: &nbsp;</small></td>
                  <td>${member.dues15_amount} Euro</td>
                </tr>
                <tr>
                  <td><small>ermäßigter Beitrag: &nbsp;</small></td>
                  <td>${member.dues15_amount_reduced} Euro</td>
                </tr>
              </table>
              <p>
                
                <form class="form-inline"
                      action="${request.route_url('dues15_reduction', member_id=member.id)}"
                      method="post">
                  <label>ermäßigen auf:</label> 
                     <input type="text"
                           class="form-control"
                           title="foo"
                           name="amount"
                           value="${member.dues15_amount_reduced or member.dues15_amount}">
                    <input name="submit" type="submit"
                           class="btn btn-primary"
                           value="Reduce Dues.">
                </form>
              </p>
              <p class="lead alert alert-danger">
                <span  color="red" tal:repeat="error request.session.pop_flash('dues15_message_to_staff')">
                  ${error}
                </span>
              </p>              
              <p>
                see also <a href="${request.route_url('dues15_listing')}"
                            class="btn btn-primary">Dues15 Invoices Listing</a>
              </p>
            </td>
          </tr>
        </table>
      </div>

  </tal:block>
</html>
