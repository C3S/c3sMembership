<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="backend">
  <!--! styles -->
  <tal:block metal:fill-slot="css">
    <link rel="stylesheet" href="${request.static_url('deform:static/css/form.css')}"
          type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="${request.static_url('deform:static/css/typeahead.css')}"
          type="text/css" media="screen" charset="utf-8" />
    <!--! jquery and deform.js need to be on top for autocomplete -->
    <script src="${request.static_url('c3smembership:static/jquery/jquery.min.js')}"
            type="text/javascript"></script>
    <!-- Krissik -->
    <script type="text/javascript">
        $().ready(function() {
            console.debug("ready");
            $(".delete-link").click(function(event) {
                event.preventDefault();
                member_id = $(this).attr('id').split('-')[2];
                ajaxUrl = '${request.route_url('get_member', memberid=0)}'
                ajaxUrl = ajaxUrl.substring(0, ajaxUrl.length - 1) + member_id;
                member_data = $.get(
                  ajaxUrl,
                  function(member) {
                    answer = confirm("Do you want to delete member " + member.id + " \"" + member.lastname + ", " + member.firstname + "\"?");
                    if (answer) {
                      deleteUrl = '${request.route_url('delete_entry', memberid='{memberid}', _query={'redirect': 'membership_listing_backend_only'})}';
                      deleteUrl = deleteUrl.replace(encodeURIComponent('{memberid}'), member_id) + '&amp;deletion_confirmed=1';
                      window.location.href = deleteUrl;
                    }
                  }
                );
            });
            $(".send-reminder").click(function(event) {
                member_id = $(this).attr('id').split('-')[2];
                member_name = $(this).attr('membername');
                answer = confirm("Are you sure you want to send the reminder email to " + member_name + " (afm id " + member_id + ") ?");
                if(answer == false) {
                    event.preventDefault();
                }
            });
        });
    </script>
    <!-- /Krissik -->
    <script src="${request.static_url('deform:static/scripts/deform.js')}"
            type="text/javascript"></script>
  </tal:block>    <!--! javascripts -->
  <tal:block metal:fill-slot="javascript">
    <script src="${request.static_url('deform:static/scripts/typeahead.min.js')}"
            type="text/javascript"></script>
    <script src="${request.static_url('deform:static/scripts/jquery.form.js')}"
            type="text/javascript"></script>
  </tal:block>
  <tal:block metal:fill-slot="top">
    <h1>Memberships <small>see &amp; edit accepted memberships</small></h1>
    <h2 tal:condition="message" class="message" id="message">${message}</h2>
    <h3 tal:repeat="message request.session.pop_flash('messages')"
        class="message" id="message" style="color: red;">${message}</h3>
    <div>
      <!--! links to other pages -->
      <a href="${request.route_url('dashboard', number=0, orderby='id', order='asc')}"
         class="btn btn-primary">Dashboard</a>
      <a href="${request.route_url('membership_listing_alphabetical', number=0, orderby='id', order='asc')}"
         class="btn btn-success">Alphabetical Membership List (printout view)</a>
      <a href="${request.route_url('toolbox')}"
         class="btn btn-primary">Toolbox</a>
      <a href="${request.route_url('stats')}"
         class="btn btn-warning">Statistics</a>
    </div>
    <p>Number of data sets: ${_number_of_datasets}
    </p>
  </tal:block>
  <tal:block metal:fill-slot="middle">
    <p>
      <a id="navigate_first"
         tal:condition="not is_first_page"
         href="${request.route_url('membership_listing_backend', number=0, orderby=orderby, order=order)}"
         class="glyphicon glyphicon-fast-backward"
         title="go to first page">
      </a>
      <a id="navigate_previous"
         tal:condition="not is_first_page"
         href="${request.route_url('membership_listing_backend', number=previous, orderby=orderby, order=order)}"
         class="glyphicon glyphicon-step-backward"
         title="go to previous page">
      </a>
      Page ${current+1} of ${last_page+1}
      <a id="navigate_next"
         tal:condition="not is_last_page"
         href="${request.route_url('membership_listing_backend', number=next, orderby=orderby, order=order)}"
         class="glyphicon glyphicon-step-forward"
         title="go to next page">
      </a>
      <a id="navigate_last"
         tal:condition="not is_last_page"
         href="${request.route_url('membership_listing_backend', number=last_page, orderby=orderby, order=order)}"
         class="glyphicon glyphicon-fast-forward"
         title="go to last page">
      </a>
      
    </p>
    <table class="table table-striped"><!--! the actual table  -->
        <tr class="table-striped">
            <th><!--! sorting -->
                id <br />
                <a href="${request.route_url('membership_listing_backend', number=current, orderby='id', order='asc')}" title="sort by id: ascending" class="glyphicon glyphicon-chevron-up"></a>
                <a href="${request.route_url('membership_listing_backend', number=current, orderby='id', order='desc')}" title="sort by id: descending" class="glyphicon glyphicon-chevron-down"></a>
            </th>
            <th>
                bc &amp; ga<br />
                invitation
            </th>
            <th>
                dues<br />
                invoice
            </th>
            <th>
                certificate
            </th>
            <th>
                mtype<br />
                status
            </th>
            <th>
                firstname <br />
                <a href="${request.route_url('membership_listing_backend', number=current, orderby='firstname', order='asc')}" title="sort by firstname: ascending" class="glyphicon glyphicon-chevron-up"></a>
                <a href="${request.route_url('membership_listing_backend', number=current, orderby='firstname', order='desc')}" title="sort by firstname: descending" class="glyphicon glyphicon-chevron-down"></a>
            </th>
            <th>
                lastname <br />
                <a href="${request.route_url('membership_listing_backend', number=current, orderby='lastname', order='asc')}" title="sort by lastname: ascending" class="glyphicon glyphicon-chevron-up"></a>
                <a href="${request.route_url('membership_listing_backend', number=current, orderby='lastname', order='desc')}" title="sort by lastname: descending" class="glyphicon glyphicon-chevron-down"></a>
            </th>
            <th>email</th>
            <th>email<br />conf'd?</th>
            <th># shares</th>
            <th>edit</th>
            <th>delete</th>
        </tr>
        <!--! loop over the list of applications for membership -->
        <tr tal:repeat="member members" tal:attributes="id python: 'member_{0}'.format(member.id)">
            <td id="${id}">
                <a href="/detail/${member.id}">${member.id}</a>
                <div tal:condition="member.membership_accepted">
                    m${member.membership_number}
                </div>
                <div tal:condition="member.is_duplicate">
                    <a href="$request.route_url('detail', memberid=member.is_duplicate_of)">
                        dup:${member.is_duplicate_of}
                    </a>
                </div>
            </td>
            <td>
                <a tal:condition="member.email_invite_flag_bcgv16 is not True"
                    href="${request.route_url('invite_member', m_id=member.id)}"
                    title="invitation not sent yet. Click to send!"
                    class="btn btn-danger"></a>
                <a tal:condition="member.email_invite_flag_bcgv16 is True"
                    href="${request.route_url('invite_member', m_id=member.id)}"
                    title="gesendet ${member.email_invite_date_bcgv16.strftime('am %d.%m.%Y um %H:%M')}"
                    class="btn btn-success"></a>
            </td>
            <td>
                <a tal:condition="member.dues15_invoice is False"
                    href="${request.route_url('send_dues_invoice_email', member_id=member.id)}"
                    title="dues invoice not sent yet. Click to send!"
                    class="btn btn-danger"></a>
                <a tal:condition="member.dues15_invoice is True"
                    href="${request.route_url('send_dues_invoice_email', member_id=member.id)}"
                    title="gesendet ${member.dues15_invoice_date.strftime('am %d.%m.%Y um %H:%M')}"
                    class="btn btn-success"></a>
            </td>
            <td>
                <a tal:condition="not member.certificate_email"
                href="${request.route_url('certificate_mail', id=member.id)}"
                title="certificate not sent yet"
                class="btn btn-warning"></a>
                <a tal:condition="member.certificate_email"
                href="${request.route_url('certificate_mail', id=member.id)}"
                title="gesendet ${member.certificate_email_date.strftime('am %d.%m.%Y um %H:%M')}"
                class="btn btn-success"></a>
                <a href="${request.route_url('certificate_pdf_staff', id=member.id, name=member.get_url_safe_name())}"
                title="Mitgliedschaftsurkunde ansehen"
                class="btn btn-success">PDF</a>
            </td>
            <td>
                <a tal:condition="(member.membership_type == 'startnext') or
                        (member.membership_type == 'unknown') or
                        (member.membership_type == '')"
                href="${request.route_url('mail_mtype_form', afmid=member.id)}"
                title="sende email mit mitgliedschafts-status-abfrage/link zum formular"
                class="btn btn-danger">
                    go
                </a>
                <a tal:condition="member.membership_type == 'pending'"
                title="mail ging raus ${member.mtype_email_date.strftime('am %d.%m.%Y um %H:%M')}"
                class="btn btn-warning">
                    waiting
                </a>
                <a tal:condition="(member.membership_type == 'investing') or
                        (member.membership_type == 'normal')"
                title="status bekannt: ${member.membership_type}"
                class="btn btn-default">
                    ok
                </a>
            </td>
            <!-- <td><a href="/detail/${member.id}">${member.email_confirm_code}</a></td> -->
            <td>${member.firstname}</td>
            <td>${member.lastname}</td>
            <td>
                <a href="mailto:${member.email}" title="${member.email}">mailto</a>
            </td>
            <td>
                <div>
                    <a tal:condition="not member.email_is_confirmed and (isinstance(member.email_confirm_token, type(None)))"
                    href="${request.route_url('mail_mail_confirmation',
                     memberid=member.id)}"
                    title="(click to send email confirmation email)"
                    class="btn btn-danger">No...</a>
                    <a tal:condition="(not member.email_is_confirmed) and (not isinstance(member.email_confirm_token, type(None)))"
                    href="${request.route_url('mail_mail_confirmation',
                     memberid=member.id)}"
                    title="sent ${member.email_confirm_mail_date.strftime('%d.%m.%Y %H:%M')} (click to send email confirmation email again)"
                    class="btn btn-warning">Waiting...</a>
                    <a tal:condition="member.email_is_confirmed"
                    href="${request.route_url('mail_mail_confirmation',
                     memberid=member.id)}"
                    title="${member.email_confirm_mail_date}"
                    class="btn btn-default">Yes.</a>
                </div>
            </td>
            <td>
                <div>
                    ${member.num_shares}
                    <a href="${request.route_url('detail', memberid=member.id)}">[detail]</a>
                </div>
            </td><!--! how many shares? -->
            <td><!--! edit application -->
                <a href="${request.route_url('edit', _id=member.id)}"
                class="btn btn-warning">edit</a>
            </td>
            <td><!--! delete application -->
                <a href="${request.route_url('delete_entry', memberid=member.id, _query={'redirect': 'membership_listing_backend_only'})}"
                class="btn btn-danger delete-link"
                id="delete-link-${member.id}" >delete</a>
            </td>
        </tr>
    </table>
    <!--! end of table -->
    <p>
      Page ${current+1} of ${last_page+1} <br/>
      <a tal:condition="not is_first_page"
         href="${request.route_url('membership_listing_backend', number=previous, orderby=orderby, order=order)}">
        &lt;previous
      </a>
      <a tal:condition="not is_last_page"
         href="${request.route_url('membership_listing_backend', number=next, orderby=orderby, order=order)}">
        next&gt;
      </a>
    </p>
    <div>Showing (up to) ${num_display} at a time. Change to
      <form action="${request.route_url('membership_listing_backend', number=0, orderby=orderby, order=order)}"
            method="post"
            class="form">
        <p>
          <input name="num_to_show" type="text"
                 size="3" maxlength="3"
                 value="${num_display}"
                 class="form-control"/>
        </p>
      </form>
    </div>
    <p>
      Please <a href="${request.route_url('logout')}">log out</a>
      when you are done.
    </p>
  </tal:block>
</html>
